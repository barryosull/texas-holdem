<html>
<head>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.slim.js" integrity="sha256-Dul4c09cdrWKXVtallPxF558lwxMwCC8dXJdZ0PVW54=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/js-cookie/2.2.1/js.cookie.min.js" integrity="sha256-oE03O+I6Pzff4fiMqwEGHbdfcW7a3GRRxlL+U49L5sA=" crossorigin="anonymous"></script>

<style type="text/css">

.card {
    width: 80px;
    height: auto;
    border: 1px solid #aaa;
    background-color: #fff;
    margin: 5px;
}

.seat {
    float: left;
    width: 190px;
    height: 150px;
    padding: 10px;
    border: 1px solid #aaa;
    margin: 0 10px;
}

</style>

<script type="text/javascript">

/************************************
 * Deck interface, calls the HTTP API
 ************************************/
var Deck = function(jquery)
{
    this.jquery = jquery;
};

Deck.prototype.dealHands = function()
{
    this.jquery.post("api/deal");
};

Deck.prototype.dealFlop = function()
{
    this.jquery.post("api/flop/");
};

Deck.prototype.dealTurn = function()
{
    this.jquery.post("api/turn/");
};

Deck.prototype.dealRiver = function()
{
    this.jquery.post("api/river/");
};

function uuidv4() {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
    });
}

var Controller = {
    socket: null,
    playerId: null
};

/**
 * @param deck {Deck}
 */
Controller.startGame = function(deck)
{
    View.clearTable();
    View.showFlopButton();
    deck.dealHands();
};

/**
 * @param deck {Deck}
 */
Controller.dealFlop = function(deck)
{
    deck.dealFlop();
    View.showTurnButton();
};

/**
 * @param deck {Deck}
 */
Controller.dealTurn = function(deck)
{
    deck.dealTurn();
    View.showRiverButton();
};

/**
 * @param deck {Deck}
 */
Controller.dealRiver = function(deck)
{
    deck.dealRiver();
    View.hideCommunityCardsButtons();
};

Controller.joinGame = function(playerName)
{
    this.socket = io();
    this.playerId = Controller.getPlayerId() ?? Controller.createPlayerId();

    this.socket.emit('newPlayer', {playerId: this.playerId, playerName: playerName});

    this.socket.on('seatFilled', function(seats){
        if (Controller.isFirstPlayer(seats)) {
            View.enableControls();
        }
        View.renderSeats(seats, Controller.playerId);
    });

    this.socket.on('seatEmptied', function(seat){
        View.renderEmptySeat(seat);
    });

    this.socket.on('hand', function(hand){
        View.renderDownFacingHands();
        View.renderPlayerHand(Controller.playerId, hand);
    });

    this.socket.on('flop', function(flop){
        View.renderFlop(flop);
    });

    this.socket.on('turn', function(turn){
        View.renderTurn(turn);
    });

    this.socket.on('river', function(river){
        View.renderRiver(river);
    });

    this.socket.on('existingSession', function(){
        alert("Other tab/window already opened on this machine. Please go to the active tab/window to play.");
    });

    View.hideCommunityCardsButtons();
};

Controller.getPlayerId = function()
{
    return Cookies.get('playerId');
};

Controller.createPlayerId = function()
{
    var playerId = uuidv4();
    Cookies.set('playerId', playerId);
    return playerId;
};

Controller.isFirstPlayer = function(seats)
{
    for (var index in seats) {
        var seat = seats[index];
        if (seat.playerId) {
            return seat.playerId === Controller.playerId;
        }
    }

    return false;
};

var View = {};

View.renderSeats = function(seats, currentPlayerId)
{
    for (var index in seats) {
        var seat = seats[index];
        if (seat.playerId) {
            View.renderSeat(seat.seat, seat.playerId, seat.playerName, currentPlayerId);
        } else {
            View.renderEmptySeat(seat.seat);
        }
    }
};

View.renderSeat = function(seat, playerId, playerName, currentPlayerId)
{
    var title = "Seat " + (seat + 1) + ": " + playerName;
    if (playerId === currentPlayerId) {
        title = "<b>" + title + "</b>";
    }

    var seatHtml = "<div id='seat-" + seat + "' class='seat'>" + title + "<br><span class='cards' id='player-" + playerId + "'></span></div>";

    if ($(`#seat-${seat}`).length) {
        $(`#seat-${seat}`).replaceWith(seatHtml);
    } else {
        View.getHandsDiv(seat).append(seatHtml);
    }
};

View.renderEmptySeat = function(seat)
{
    var title = "Seat " + (seat + 1) + " (empty)";

    var seatHtml = "<div id='seat-" + seat + "' class='seat'>" + title + "<br><span></span></div>";

    if ($(`#seat-${seat}`).length) {
        $(`#seat-${seat}`).replaceWith(seatHtml);
    } else {
        View.getHandsDiv(seat).append(seatHtml);
    }
};

View.getHandsDiv = function(seat)
{
    if (seat < 4) {
        return $('#hands-1-to-4');
    }
    return $('#hands-5-to-8');
};

View.renderPlayerHand = function(playerId, cards)
{
    var hand = View.renderCards(cards);
    $('#player-' + playerId).html(hand);
};

View.renderDownFacingHands = function()
{
    $('.seat .cards').each(function(){
        var hand = [View.renderDownFacingCard(), View.renderDownFacingCard()];
        $(this).html(hand);
    });
};

View.renderFlop = function(flop)
{
    $('#cards').html(View.renderCards(flop));
};

View.renderTurn = function(card)
{
    $('#cards').html( $('#cards').html() + View.renderCards([card]));
};

View.renderRiver = function(card)
{
    $('#cards').html( $('#cards').html() + View.renderCards([card]));
};

View.clearTable = function()
{
	$('#cards').html('');
};

View.renderCards = function(cards)
{
    return cards.map(function(card){
        return View.renderCard(card);
    });
};

View.renderCard = function(card)
{
    return '<img src="images/' + card + '.png" class="card"/>';
};

View.renderDownFacingCard = function()
{
    return '<img src="https://i.pinimg.com/originals/10/80/a4/1080a4bd1a33cec92019fab5efb3995d.png" class="card"/>';
};

View.enableControls = function()
{
    $("#controls").show();
};

View.showFlopButton = function()
{
    View.hideCommunityCardsButtons();
    $('#flop').show();
};

View.showTurnButton = function()
{
    View.hideCommunityCardsButtons();
    $('#turn').show();
};

View.showRiverButton = function()
{
    View.hideCommunityCardsButtons();
    $('#river').show();
};

View.hideCommunityCardsButtons = function()
{
    $('#community-cards button').hide();
};

$(function(){

	var deck;

	$("#deal").click(function(){
        deck = new Deck($);
        Controller.startGame(deck);
	});
	$("#flop").click(function(){
        Controller.dealFlop(deck);
	});
	$("#turn").click(function(){
        Controller.dealTurn(deck);
	});
	$("#river").click(function(){
        Controller.dealRiver(deck);
	});

	var isValidName = false;
    var playerName = Cookies.get('playerName');

	while (!playerName && !isValidName) {
        playerName = prompt("What is your screen name?");

        if (playerName.length !== 0) {
            Cookies.set('playerName', playerName);
            break;
        }

        alert("Name cannot be empty.")
    }

	Controller.joinGame(playerName);
});

</script>
</head>
<body style="margin: 0; background-color: #16840d; ">
<div class="table" style="padding: 20px;">

    <div id="hands-1-to-4" style="width: 940px; margin: 20px auto;">

    </div>
    <div style="clear:both"></div>

    <div id="cards" style="margin: 20px auto; height: 130px; width: 460px; padding: 10px; border: 1px solid #aaa">

    </div>

    <div id="hands-5-to-8" style="width: 940px; margin: 20px auto;">

    </div>
    <div style="clear:both"></div>

    <br><br>

    <div style="display: none" id="controls">
        <button id="deal">Deal</button>
        <span id="community-cards">
            <button id="flop">Flop</button>
            <button id="turn">Turn</button>
            <button id="river">River</button>
        </span>
    </div>
</div>
</body>
</html>