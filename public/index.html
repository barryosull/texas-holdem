<html>
<head>

<link href="https://fonts.googleapis.com/css2?family=Great+Vibes&display=swap" rel="stylesheet">

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.slim.js" integrity="sha256-Dul4c09cdrWKXVtallPxF558lwxMwCC8dXJdZ0PVW54=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/js-cookie/2.2.1/js.cookie.min.js" integrity="sha256-oE03O+I6Pzff4fiMqwEGHbdfcW7a3GRRxlL+U49L5sA=" crossorigin="anonymous"></script>

<style type="text/css">

body {
    font-family: Arial;
}

#cards {
    position: relative;
    z-index: 2;
}

.card {
    width: 80px;
    height: auto;
    border: 1px solid #aaa;
    background-color: #fff;
    margin: 5px;
}

.card.grey {
    -webkit-filter: grayscale(100%);
    -moz-filter: grayscale(100%);
    -o-filter: grayscale(100%);
    filter: grayscale(100%);
    opacity: 0.5;
}

.card.winner {
    -webkit-box-shadow: 0px 0px 10px 2px rgba(255,255,255,1);
    -moz-box-shadow: 0px 0px 10px 2px rgba(255,255,255,1);
    box-shadow: 0px 0px 10px 2px rgba(255,255,255,1);
    Copy Text
}

.seat {
    float: left;
    width: 190px;
    height: 150px;
    padding: 10px;
    border: 1px solid #aaa;
    margin: 0 10px;
}

.controls button {
    font-size: 16px;
    margin: 10px;
    display: block;
}

</style>

<script type="text/javascript">

/************************************
 * Round interface, calls the HTTP API
 ************************************/
var Round = function(jquery)
{
    this.jquery = jquery;
};

Round.prototype.dealHands = function()
{
    this.jquery.post("api/deal");
};

Round.prototype.dealFlop = function()
{
    this.jquery.post("api/flop/");
};

Round.prototype.dealTurn = function()
{
    this.jquery.post("api/turn/");
};

Round.prototype.dealRiver = function()
{
    this.jquery.post("api/river/");
};

Round.prototype.finishRound = function()
{
    this.jquery.post("api/finish/");
};

Round.prototype.foldHand = function(playerId)
{
    this.jquery.post("api/fold/" + playerId);
};

function uuidv4() {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
    });
}

var Controller = {
    socket: null,
    playerId: null
};

/**
 * @param round {Round}
 */
Controller.startGame = function(round)
{
    View.showFlopButton();
    round.dealHands();
};

/**
 * @param round {Round}
 */
Controller.dealFlop = function(round)
{
    round.dealFlop();
    View.showTurnButton();
};

/**
 * @param round {Round}
 */
Controller.dealTurn = function(round)
{
    round.dealTurn();
    View.showRiverButton();
};

/**
 * @param round {Round}
 */
Controller.dealRiver = function(round)
{
    round.dealRiver();
    View.showFinishButton();
};

Controller.finishRound = function(round)
{
    round.finishRound();
    View.hideCommunityCardsButtons();
};

Controller.foldHand = function(round)
{
    round.foldHand(Controller.playerId);
    View.disableFoldButton();
};

Controller.joinGame = function(playerName)
{
    this.socket = io();
    this.playerId = Controller.getPlayerId() ?? Controller.createPlayerId();

    this.socket.emit('newPlayer', {playerId: this.playerId, playerName: playerName});

    this.socket.on('seatFilled', function(seats){
        if (Controller.isFirstPlayer(seats)) {
            View.enableControls();
        }
        View.renderSeats(seats, Controller.playerId);
    });

    this.socket.on('seatEmptied', function(seat){
        View.renderEmptySeat(seat);
    });

    this.socket.on('roundStarted', function(hand){
        View.clearTable();
        View.renderDownFacingHands();
        View.enableFoldButton();
        View.renderPlayerHand(hand);
    });

    this.socket.on('winningHand', function(hand){
        View.renderPlayerHand(hand);
        View.highlightWinner(hand.playerId);
    });

    this.socket.on('flop', function(flop){
        View.renderFlop(flop);
    });

    this.socket.on('turn', function(turn){
        View.renderTurn(turn);
    });

    this.socket.on('river', function(river){
        View.renderRiver(river);
    });

    this.socket.on('playerFolded', function(playerId){
        View.foldPlayerHand(playerId);
    });

    this.socket.on('existingSession', function(){
        alert("Other tab/window already opened on this machine. Please go to the active tab/window to play.");
    });

    View.hideCommunityCardsButtons();
};

Controller.getPlayerId = function()
{
    return Cookies.get('playerId');
};

Controller.createPlayerId = function()
{
    var playerId = uuidv4();
    Cookies.set('playerId', playerId);
    return playerId;
};

Controller.isFirstPlayer = function(seats)
{
    for (var index in seats) {
        var seat = seats[index];
        if (seat.playerId) {
            return seat.playerId === Controller.playerId;
        }
    }

    return false;
};

Controller.wantsToChangeName = function()
{
    var url_string = window.location.href;
    var url = new URL(url_string);
    var c = url.searchParams.get("changeName");
    if (c) {
        return true;
    }

    return false;
};

var View = {};

View.renderSeats = function(seats, currentPlayerId)
{
    for (var index in seats) {
        var seat = seats[index];
        if (seat.playerId) {
            View.renderSeat(seat.seat, seat.playerId, seat.playerName, currentPlayerId);
        } else {
            View.renderEmptySeat(seat.seat);
        }
    }
};

View.renderSeat = function(seat, playerId, playerName, currentPlayerId)
{
    var title = "Seat " + (seat + 1) + ": " + playerName;
    if (playerId === currentPlayerId) {
        title = "<b>" + title + "</b>";
    }

    var seatHtml = "<div id='seat-" + seat + "' class='seat'><span class='name'>" + title + "</span><br><span class='cards' id='player-" + playerId + "'></span></div>";

    if ($(`#seat-${seat}`).length) {
        $(`#seat-${seat}`).removeClass('empty');
        $(`#seat-${seat} .name`).html(title);
        $(`#seat-${seat} .cards`).attr('id', 'player-' + playerId);
    } else {
        View.getHandsDiv(seat).append(seatHtml);
    }
};

View.renderEmptySeat = function(seat)
{
    var title = "Seat " + (seat + 1) + " (empty)";

    var seatHtml = "<div id='seat-" + seat + "' class='seat empty'><span class='name'>" + title + "</span><br><span class='cards'></span></div>";

    if ($(`#seat-${seat}`).length) {
        $(`#seat-${seat}`).addClass('empty');
        $(`#seat-${seat} .name`).html(title);
    } else {
        View.getHandsDiv(seat).append(seatHtml);
    }
};

View.getHandsDiv = function(seat)
{
    if (seat < 4) {
        return $('#hands-1-to-4');
    }
    return $('#hands-5-to-8');
};

View.renderPlayerHand = function(hand)
{
    var handHtml = View.renderCards(hand.cards);
    $('#player-' + hand.playerId).html(handHtml);
};

View.foldPlayerHand = function(playerId)
{
    $('#player-' + playerId + ' .card').each(function(){
       $(this).addClass('grey');
    });
};

View.renderDownFacingHands = function()
{
    $('.seat:not(.empty) .cards').each(function(){
        var hand = [View.renderDownFacingCard(), View.renderDownFacingCard()];
        $(this).html(hand);
    });
};

View.renderFlop = function(flop)
{
    $('#cards').html(View.renderCards(flop));
};

View.renderTurn = function(card)
{
    $('#cards').html( $('#cards').html() + View.renderCards([card]));
};

View.renderRiver = function(card)
{
    $('#cards').html( $('#cards').html() + View.renderCards([card]));
};

View.clearTable = function()
{
	$('#cards').html('');
};

View.renderCards = function(cards)
{
    return cards.map(function(card){
        return View.renderCard(card);
    });
};

View.renderCard = function(card)
{
    return '<img src="images/' + card + '.png" class="card"/>';
};

View.renderDownFacingCard = function()
{
    return '<img src="/images/back.png" class="card"/>';
};

View.highlightWinner = function(playerId)
{
    $('#player-' + playerId + ' .card').each(function(){
        $(this).addClass('winner');
    });
};

View.enableControls = function()
{
    $("#admin-controls").show();
};

View.showFlopButton = function()
{
    View.hideCommunityCardsButtons();
    $('#flop').show();
};

View.showTurnButton = function()
{
    View.hideCommunityCardsButtons();
    $('#turn').show();
};

View.showRiverButton = function()
{
    View.hideCommunityCardsButtons();
    $('#river').show();
};

View.showFinishButton = function()
{
    View.hideCommunityCardsButtons();
    $('#finish').show();
};

View.hideCommunityCardsButtons = function()
{
    $('#community-cards button').hide();
};

View.disableFoldButton = function()
{
    $('#fold').attr('disabled', 'disabled');
};

View.enableFoldButton = function()
{
    $('#fold').removeAttr('disabled');
};

$(function(){

	var round = new Round($);

	$("#deal").click(function(){
        Controller.startGame(round);
	});
	$("#flop").click(function(){
        Controller.dealFlop(round);
	});
	$("#turn").click(function(){
        Controller.dealTurn(round);
	});
	$("#river").click(function(){
        Controller.dealRiver(round);
	});
    $("#finish").click(function(){
        Controller.finishRound(round);
    });
    $("#fold").click(function(){
        Controller.foldHand(round);
    });

	var isValidName = false;
	var wantsToChangeName = Controller.wantsToChangeName();
    var playerName = Cookies.get('playerName');

	while ((!playerName || wantsToChangeName) && !isValidName) {
        playerName = prompt("What is your screen name?");

        if (playerName.length !== 0) {
            Cookies.set('playerName', playerName);
            break;
        }

        alert("Name cannot be empty.")
    }

	Controller.joinGame(playerName);
});

</script>
</head>
<body style="margin: 0; background-color: #16840d; ">
<div class="table" style="padding: 20px;">

    <div id="hands-1-to-4" style="width: 940px; margin: 20px auto;">

    </div>
    <div style="clear:both"></div>

    <div style="margin: 20px auto; height: 130px; width: 460px; padding: 10px; border: 1px solid #aaa; position: relative">
        <div style="z-index: 1; width: 460px; font-size: 45px; text-align: center; padding-top: 50px; font-family: 'Great Vibes', cursive; color: #2e580e; position: absolute; top: 0; left: 0;">Texas Holdem</div>
        <div id="cards"></div>
    </div>

    <div id="hands-5-to-8" style="width: 940px; margin: 20px auto;">

    </div>
    <div style="clear:both"></div>

    <br><br>

    <div id="player-controls" class="controls" style="padding: 20px; background-color: white; border: 1px solid #aaa; position: fixed; top: 0; left: 0;">
        <h4>Players controls</h4>
        <button id="fold" disabled="disabled">Fold</button>
    </div>

    <div id="admin-controls" class="controls" style="display: none; padding: 20px; background-color: white; border: 1px solid #aaa; position: fixed; top: 0; right: 0;">
        <h4>Admin controls</h4>
        <span id="community-cards">
            <button id="flop">Flop</button>
            <button id="turn">Turn</button>
            <button id="river">River</button>
            <button id="finish">Finish</button>
        </span>
        <button id="deal">Deal</button>
    </div>
</div>
</body>
</html>