<html>
<head>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.slim.js" integrity="sha256-Dul4c09cdrWKXVtallPxF558lwxMwCC8dXJdZ0PVW54=" crossorigin="anonymous"></script>

<script type="text/javascript">

Array.prototype.forEach = function(callback)
{
    for (var key in this) {
        var item = this[key];
        callback(item);
    }
};

var Deck = function(jquery)
{
    this.jquery = jquery;
};

Deck.prototype.dealHands = function()
{
    this.jquery.post("api/deal");
};

Deck.prototype.dealFlop = function()
{
    this.jquery.post("api/flop/");
};

Deck.prototype.dealTurn = function()
{
    this.jquery.post("api/turn/");
};

Deck.prototype.dealRiver = function()
{
    this.jquery.post("api/river/");
};

var Controller = {
    socket: null,
    playerId: null
};

/**
 * @param deck {Deck}
 */
Controller.startGame = function(deck)
{
    deck.dealHands();
};

/**
 * @param deck {Deck}
 */
Controller.dealFlop = function(deck)
{
    deck.dealFlop();
};

/**
 * @param deck {Deck}
 */
Controller.dealTurn = function(deck)
{
    deck.dealTurn();
};

/**
 * @param deck {Deck}
 */
Controller.dealRiver = function(deck)
{
    deck.dealRiver();
};

Controller.joinGame = function()
{
    this.socket = io();

    this.socket.on('playerId', function(playerId){
       this.playerId = playerId;
       console.log("player id " + playerId);
        View.renderPlayer(this.playerId);
    });

    this.socket.on('hand', function(hand){
        View.renderPlayerHand(this.playerId, hand);
    });

    this.socket.on('flop', function(flop){
        View.renderFlop(flop);
    });

    this.socket.on('turn', function(turn){
        View.renderTurn(turn);
    });

    this.socket.on('river', function(river){
        View.renderRiver(river);
    });
};

var View = {};

View.renderPlayers = function(players)
{
	for (var i = 0; i < players; i++) {
	    View.renderPlayer(i);
	}
};

View.renderPlayer = function(playerId)
{
    var player = "<div style='float:left; margin-right: 20px;'>Player " + (playerId + 1) + ": <br><span id='player-" + playerId + "'></span></div>"
    $('#hands').append(player);
};

View.renderPlayerHand = function(playerId, cards)
{
    var hand = View.renderCards(cards);
    $('#player-' + playerId).html(hand);
};

View.renderFlop = function(flop)
{
    $('#cards').html(View.renderCards(flop));
};

View.renderTurn = function(card)
{
    $('#cards').html( $('#cards').html() + View.renderCards([card]));
};

View.renderRiver = function(card)
{
    $('#cards').html( $('#cards').html() + View.renderCards([card]));
};

View.clearTable = function()
{
	$('#cards').html('');
    $('#hands').html('');
};

View.renderCards = function(cards)
{
    return cards.map(function(card){
        return View.renderCard(card);
    });
};

View.renderCard = function(card)
{
    return '<img src="images/' + card + '.png" style="width: 80px; height: auto; border: 1px solid #aaa; margin: 5px;"/>';
};

$(function(){

	var deck;

	$("#deal").click(function(){
        deck = new Deck($);
        Controller.startGame(deck);
	});
	$("#flop").click(function(){
        Controller.dealFlop(deck);
	});
	$("#turn").click(function(){
        Controller.dealTurn(deck);
	});
	$("#river").click(function(){
        Controller.dealRiver(deck);
	});

	Controller.joinGame();
});

</script>
</head>
<body>

<h3>Cards</h3>
<div id="cards">

</div>

<h3>Players</h3>
<div id="hands">

</div>
<div style="clear:both"></div>
<br><br>
<button id="deal">Deal</button>
<button id="flop">Flop</button>
<button id="turn">Turn</button>
<button id="river">River</button>

</body>
</html>