<html>
<head>

<link href="https://fonts.googleapis.com/css2?family=Great+Vibes&display=swap" rel="stylesheet">

<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.slim.js" integrity="sha256-Dul4c09cdrWKXVtallPxF558lwxMwCC8dXJdZ0PVW54=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/js-cookie/2.2.1/js.cookie.min.js" integrity="sha256-oE03O+I6Pzff4fiMqwEGHbdfcW7a3GRRxlL+U49L5sA=" crossorigin="anonymous"></script>
<style type="text/css">

body {
    font-family: Arial;
    text-align: center;
    background-color: #350303;
}

#cards {
    position: relative;
    z-index: 2;
    padding: 10px;
}

.table-border {
    position: relative;
    background-color: #63370b;
    display: inline-block;
    margin: 20px auto;
    padding: 15px;
    -moz-box-shadow:    inset 0 0 10px #000000;
    -webkit-box-shadow: inset 0 0 10px #000000;
    box-shadow:         inset 0 0 10px #000000;
}

.table {
    position: relative;
    background: url(/images/felt.jpg);
    padding: 20px;
    display: inline-block;
    text-align: left;
    -moz-box-shadow:    inset 0 0 10px #000000;
    -webkit-box-shadow: inset 0 0 10px #000000;
    box-shadow:         inset 0 0 10px #000000;
}

.controls {
    padding: 10px 20px;
    background-color: #a8cc92;
    border-radius: 10px;
    margin: 10px;
    width: 90px;
}

.controls .title {
    font-weight: bold;
}

.controls button {
    margin: 10px 0;
    box-shadow: 0px 1px 0px 0px #fff6af;
    background: linear-gradient(to bottom, #ffec64 5%, #ffab23 100%);
    background-color: #ffec64;
    border-rgameIdadius: 6px;
    border: 1px solid #ffaa22;
    display: inline-block;
    cursor: pointer;
    color: #333333;
    font-family: Arial;
    font-size: 15px;
    font-weight: bold;
    padding: 6px 24px;
    text-decoration: none;
    text-shadow: 0px 1px 0px #ffee66;
}

.controls button:hover {
    background:linear-gradient(to bottom, #ffab23 5%, #ffec64 100%);
    background-color:#ffab23;
}

.controls button:active {
    position:relative;
    top:1px;
}

.controls button:disabled {
    opacity: 0.5;
}

.seat {
    position: relative;
    float: left;
    width: 190px;
    height: 160px;
    border: 1px solid #aaa;
    margin: 0 10px;
}

.seat.dealer {
    border: 1px dashed #fff;
}

.chips {
    padding: 2px;
    border-radius: 10px;
    color: #333;
    background: #ffd742;
    border: 1px solid #ffaa22;
    line-height: 17px;
    text-align: center;
    min-width: 15px;
}

.stack {
    position: absolute;
    top: -10px;
    right: -10px;
}

.bet, .pot {
    position: absolute;
    bottom: -10px;
    right: -10px;
}

.name {
    background-color: #649c42;
    padding: 4px 10px;
    overflow: hidden;
}

.card {
    width: 80px;
    height: 118px;
    border: 1px solid #aaa;
    background-color: #fff;
    margin: 5px;

    -webkit-box-shadow: 2px 2px 5px 0px rgba(0,0,0,0.45);
    -moz-box-shadow: 2px 2px 5px 0px rgba(0,0,0,0.45);
    box-shadow: 2px 2px 5px 0px rgba(0,0,0,0.45);
}

.card.grey {
    -webkit-filter: grayscale(100%);
    -moz-filter: grayscale(100%);
    -o-filter: grayscale(100%);
    filter: grayscale(100%);
    opacity: 0.5;
}

.card.winner {
    -webkit-box-shadow: 0px 0px 10px 2px rgba(255,255,255,1);
    -moz-box-shadow: 0px 0px 10px 2px rgba(255,255,255,1);
    box-shadow: 0px 0px 10px 2px rgba(255,255,255,1);
}

</style>

<script type="text/javascript">

/************************************
 * Game interface, calls the HTTP API
 ************************************/
var Game = {
    gameId: null
};

Game.dealHands = function()
{
    $.post("api/game/" + Game.gameId + "/deal");
};

Game.dealFlop = function()
{
    $.post("api/game/" + Game.gameId + "/flop");
};

Game.dealTurn = function()
{
    $.post("api/game/" + Game.gameId + "/turn");
};

Game.dealRiver = function()
{
    $.post("api/game/" + Game.gameId + "/river");
};

Game.finishRound = function()
{
    $.post("api/game/" + Game.gameId + "/finish/");
};

Game.foldHand = function(playerId)
{
    $.post("api/game/" + Game.gameId + "/fold/" + playerId);
};

Game.makeBet = function(playerId, amount)
{
    $.post(
        "/api/game/" + Game.gameId + "/bet/" + playerId,
        {amount: amount},
        d => {},
        "json"
    );
};

function uuidv4() {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
    });
}

var Controller = {
    playerId: null
};

Controller.startGame = function()
{
    Game.dealHands();
    View.showFlopButton();
};

Controller.dealFlop = function()
{
    Game.dealFlop();
    View.showTurnButton();
};

Controller.dealTurn = function()
{
    Game.dealTurn();
    View.showRiverButton();
};

Controller.dealRiver = function()
{
    Game.dealRiver();
    View.showFinishButton();
};

Controller.finishRound = function()
{
    Game.finishRound();
};

Controller.foldHand = function()
{
    Game.foldHand(Controller.playerId);
    View.disableFoldButton();
};

Controller.placeBet = function()
{
    var amountVal = $('#amount').val();
    var amount = amountVal === "" ? 0 : parseInt($('#amount').val());
    Game.makeBet(Controller.playerId, amount);
};

Controller.joinGame = function(socket)
{
    var isValidName = false;
    var wantsToChangeName = Controller.wantsToChangeName();
    var playerName = Cookies.get('playerName');

    while ((!playerName || wantsToChangeName) && !isValidName) {
        playerName = prompt("What is your screen name?");

        if (playerName.length !== 0) {
            Cookies.set('playerName', playerName);
            break;
        }
        alert("Name cannot be empty.")
    }

    this.playerId = Controller.getPlayerId() ?? Controller.createPlayerId();

    socket.emit('newPlayer', {gameId: Game.gameId, playerId: this.playerId, playerName: playerName});

    View.hideCommunityCardsButtons();
    View.disableBetting();
    View.emptyPot();
};

Controller.getPlayerId = function()
{
    return Cookies.get('playerId');
};

Controller.createPlayerId = function()
{
    var playerId = uuidv4();
    Cookies.set('playerId', playerId);
    return playerId;
};

Controller.isFirstPlayer = function(seats)
{
    for (var index in seats) {
        var seat = seats[index];
        if (seat.playerId) {
            return seat.playerId === Controller.playerId;
        }
    }

    return false;
};

Controller.wantsToChangeName = function()
{
    var url_string = window.location.href;
    var url = new URL(url_string);
    var c = url.searchParams.get("changeName");
    return !!c;
};

Controller.getGameId = function()
{
    var url_string = window.location.href;
    var url = new URL(url_string);
    return url.searchParams.get("gameId");
};

Controller.seatFilled = function(seats)
{
    if (Controller.isFirstPlayer(seats)) {
        View.enableAdminControls();
    } else {
        View.disableAdminControls();
    }
    View.renderSeats(seats, Controller.playerId);
};

Controller.seatEmptied = function(seats)
{
    if (Controller.isFirstPlayer(seats.seats)) {
        View.enableAdminControls();
    }
    View.renderEmptySeat(seats.emptiedSeat);
};

Controller.roundStarted = function(round)
{
    View.clearTable();
    View.renderDownFacingHands();
    View.enableFoldButton();
    View.renderPlayerHand(round.hand);
    View.highlightDealer(round.dealer);
    View.enableBetting();
};

Controller.winnerByDefault = function(hand)
{
    View.disableFoldButton();
    View.highlightWinner(hand.playerId);
    View.updatePlayerStack(hand.playerId, hand.playerChips);
    View.emptyPot();
    View.disableBetting();
    View.showDealButton();
};

Controller.winningHand = function(hand)
{
    View.renderPlayerHand(hand);
    View.disableFoldButton();
    View.highlightWinner(hand.playerId);
    View.updatePlayerStack(hand.playerId, hand.playerChips);
    View.emptyPot();
    View.disableBetting();
    View.showDealButton();
};

Controller.disableLosers = function(losers)
{
    losers.forEach(playerId => {
        if (Controller.playerId === playerId) {

        }
    });
};

var View = {};

View.renderSeats = function(seats, currentPlayerId)
{
    for (var index in seats) {
        var seat = seats[index];
        if (seat.playerId) {
            View.renderSeat(seat.seat, seat.playerId, seat.playerName, seat.chips, currentPlayerId);
        } else {
            View.renderEmptySeat(seat.seat);
        }
    }
};

View.renderSeat = function(seat, playerId, playerName, chips, currentPlayerId)
{
    var title = "Seat " + (seat + 1) + ": " + playerName;
    if (playerId === currentPlayerId) {
        title = "<b>" + title + "</b>";
    }

    var $seat = $(`#seat-${seat}`);
    if ($seat.length) {
        $seat.removeClass('empty');
        $seat.find('.name').html(title);
        $seat.find('.cards').attr('id', 'player-' + playerId);
        $seat.removeClass('empty');
        $seat.find('.stack').show().text(chips);
        return;
    }

    var seatHtml =
        "<div id='seat-" + seat + "' class='seat'>" +
            "<div class='name'>" + title + "</div>" +
            "<span class='cards' id='player-" + playerId + "'></span>" +
            "<span class='chips stack'>" + chips + "</span>" +
        "</div>";

    View.getHandsDiv(seat).append(seatHtml);
};

View.renderEmptySeat = function(seat)
{
    var title = "Seat " + (seat + 1) + " (empty)";

    var $seat = $(`#seat-${seat}`);
    if ($seat.length) {
        $seat.addClass('empty');
        $seat.find('.name').html(title);
        $seat.find('.cards').html('');
        $seat.find('.stack').hide();
        return;
    }

    var seatHtml =
        "<div id='seat-" + seat + "' class='seat empty'>" +
            "<div class='name'>" + title + "</div>" +
            "<span class='cards'></span>" +
            "<span class='chips stack' style='display: none'></span>" +
        "</div>";

    View.getHandsDiv(seat).append(seatHtml);
};

View.getHandsDiv = function(seat)
{
    if (seat < 4) {
        return $('#hands-1-to-4');
    }
    return $('#hands-5-to-8');
};

View.renderPlayerHand = function(hand)
{
    var handHtml = View.renderCards(hand.cards);
    $('#player-' + hand.playerId).html(handHtml);
};

View.foldPlayerHand = function(playerId)
{
    $('#player-' + playerId + ' .card').each(function(){
       $(this).addClass('grey');
    });
};

View.renderDownFacingHands = function()
{
    $('.seat:not(.empty) .cards').each(function(){
        var hand = [View.renderDownFacingCard(), View.renderDownFacingCard()];
        $(this).html(hand);
    });
};

View.renderFlop = function(flop)
{
    $('#cards').html(View.renderCards(flop));
};

View.renderTurn = function(card)
{
    $('#cards').html( $('#cards').html() + View.renderCards([card]));
};

View.renderRiver = function(card)
{
    $('#cards').html( $('#cards').html() + View.renderCards([card]));
};

View.clearTable = function()
{
	$('#cards').html('');
};

View.renderCards = function(cards)
{
    return cards.map(function(card){
        return View.renderCard(card);
    });
};

View.renderCard = function(card)
{
    return '<img src="images/' + card + '.png" class="card"/>';
};

View.renderDownFacingCard = function()
{
    return '<img src="/images/back.png" class="card"/>';
};

View.highlightWinner = function(playerId)
{
    $('#player-' + playerId + ' .card').each(function(){
        $(this).addClass('winner');
    });
};

View.highlightDealer = function(playerId)
{
    $('.dealer').removeClass('dealer');
    $('#player-' + playerId).parent('.seat').addClass('dealer');
};

View.enableAdminControls = function()
{
    $("#admin-controls").show();
    View.showDealButton();
};

View.disableAdminControls = function()
{
    $("#admin-controls").hide();
};

View.showFlopButton = function()
{
    View.hideCommunityCardsButtons();
    $('#flop').show();
};

View.showTurnButton = function()
{
    View.hideCommunityCardsButtons();
    $('#turn').show();
};

View.showRiverButton = function()
{
    View.hideCommunityCardsButtons();
    $('#river').show();
};

View.showFinishButton = function()
{
    View.hideCommunityCardsButtons();
    $('#finish').show();
};

View.showDealButton = function()
{
    View.hideCommunityCardsButtons();
    $('#deal').show();
};

View.hideCommunityCardsButtons = function()
{
    $('#community-cards button').hide();
};

View.disableFoldButton = function()
{
    $('#fold').attr('disabled', 'disabled');
};

View.enableFoldButton = function()
{
    $('#fold').removeAttr('disabled');
};

View.showBet = function(bet)
{
    var $seat = $('#player-' + bet.playerId).parent('.seat');
    $seat.find('.stack').text(bet.remainingChips);
    $seat.find('.bet').remove();
    $seat.append('<div class="chips bet">' + bet.total+ '</div>')
};

View.updatePlayerStack = function(playerId, chips)
{
    var $seat = $('#player-' + playerId).parent('.seat');
    $seat.find('.stack').text(chips);
};

View.clearBets = function()
{
    $('.seat .bet').remove();
};

View.updatePot = function(pot)
{
    View.clearBets();
    $('#pot').show().text(pot);
};

View.emptyPot = function()
{
    View.clearBets();
    $('#pot').hide();
};

View.disableBetting = function() {
    $('#bet').attr('disabled', 'disabled');
};

View.enableBetting = function()
{
    $('#bet').removeAttr('disabled');
};

var Bootstrap = {};

Bootstrap.attachHtmlEventListeners = function()
{
    $("#deal").click(function(){
        Controller.startGame();
    });
    $("#flop").click(function(){
        Controller.dealFlop();
    });
    $("#turn").click(function(){
        Controller.dealTurn();
    });
    $("#river").click(function(){
        Controller.dealRiver();
    });
    $("#finish").click(function(){
        Controller.finishRound();
    });
    $("#fold").click(function(){
        Controller.foldHand();
    });
    $('#bet').click(function(){
        Controller.placeBet();
    });
};

Bootstrap.attachSocketEventListeners = function(socket)
{
    socket.on('seatFilled', Controller.seatFilled);

    socket.on('seatEmptied', Controller.seatEmptied);

    socket.on('roundStarted', Controller.roundStarted);

    socket.on('winningHand', Controller.winningHand);

    socket.on('winnerByDefault', Controller.winnerByDefault);

    socket.on('flop', View.renderFlop);

    socket.on('turn', View.renderTurn);

    socket.on('river', View.renderRiver);

    socket.on('playerFolded', View.foldPlayerHand);

    socket.on('betMade', View.showBet);

    socket.on('pot', View.updatePot);

    socket.on('losers', Controller.disableLosers);

    socket.on('existingSession', function(){
        alert("Other tab/window already opened on this machine. Please go to the active tab/window to play.");
    });
};

$(function()
{
    var socket = io();

    var gameId = Controller.getGameId();
    if (!gameId) {
        window.location.href = window.location.href + "?gameId=" + uuidv4();
        return;
    }

    Game.gameId = gameId;

    Bootstrap.attachHtmlEventListeners();
    Bootstrap.attachSocketEventListeners(socket);

    Controller.joinGame(socket);
});

</script>
</head>
<body style="margin: 0;">
<div class="table-border">
<div class="table">

    <div id="hands-1-to-4" style="width: 860px; margin: 20px auto;">

    </div>
    <div style="clear:both"></div>

    <div style="margin: 20px auto; height: 150px; width: 480px; border: 1px solid #aaa; position: relative">
        <div style="z-index: 1; width: 460px; font-size: 45px; text-align: center; padding-top: 50px; font-family: 'Great Vibes', cursive; color: #5c8a38; position: absolute; top: 0; left: 0;">Texas Holdem</div>
        <div id="cards"></div>
        <div id="pot" class="chips pot">0</div>
    </div>

    <div id="hands-5-to-8" style="width: 860px; margin: 20px auto;">

    </div>
    <div style="clear:both"></div>

    <div id="player-controls" class="controls" style="position: absolute; top: 212px; right: 30px;">
        <div class="title">Player</div>
        <button id="fold" disabled="disabled">Fold</button>
        <div>
            <input type="number" id="amount" placeholder="20" style="font-size: 16px; width: 80px;">
            <button id="bet">Bet</button>
        </div>
    </div>

    <div id="admin-controls" class="controls" style="display: none; position: absolute; top: 212px; left: 22px;">
        <div class="title">Admin</div>
        <span id="community-cards">
            <button id="flop">Flop</button>
            <button id="turn">Turn</button>
            <button id="river">River</button>
            <button id="finish">Finish</button>
            <button id="deal">Deal</button>
        </span>
    </div>
</div>
</div>
<footer style="position: fixed; bottom: 0; right: 0; width: 100%; text-align: center; color: #fff; font-size: 10px; padding: 10px; opacity: 0.5;">
    Barry O Sullivan, 2020. @barryosull
</footer>
</body>
</html>