<html>
<head>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.slim.js" integrity="sha256-Dul4c09cdrWKXVtallPxF558lwxMwCC8dXJdZ0PVW54=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/js-cookie/2.2.1/js.cookie.min.js" integrity="sha256-oE03O+I6Pzff4fiMqwEGHbdfcW7a3GRRxlL+U49L5sA=" crossorigin="anonymous"></script>

<script type="text/javascript">

Array.prototype.forEach = function(callback)
{
    for (var key in this) {
        var item = this[key];
        callback(item);
    }
};

var Deck = function(jquery)
{
    this.jquery = jquery;
};

Deck.prototype.dealHands = function()
{
    this.jquery.post("api/deal");
};

Deck.prototype.dealFlop = function()
{
    this.jquery.post("api/flop/");
};

Deck.prototype.dealTurn = function()
{
    this.jquery.post("api/turn/");
};

Deck.prototype.dealRiver = function()
{
    this.jquery.post("api/river/");
};

function uuidv4() {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
    });
}

var Controller = {
    socket: null,
    playerId: null
};

/**
 * @param deck {Deck}
 */
Controller.startGame = function(deck)
{
    View.clearTable();
    deck.dealHands();
};

/**
 * @param deck {Deck}
 */
Controller.dealFlop = function(deck)
{
    deck.dealFlop();
};

/**
 * @param deck {Deck}
 */
Controller.dealTurn = function(deck)
{
    deck.dealTurn();
};

/**
 * @param deck {Deck}
 */
Controller.dealRiver = function(deck)
{
    deck.dealRiver();
};

Controller.joinGame = function()
{
    this.socket = io();
    this.playerId = Controller.getPlayerId() ?? Controller.createPlayerId();

    this.socket.emit('playerId', this.playerId);

    this.socket.on('players', function(players){
        console.log(players);
        View.renderPlayers(players, Controller.playerId);
    });

    this.socket.on('playerRemoved', function(playerId){
        View.removePlayer(playerId);
    });

    this.socket.on('hand', function(hand){
        View.renderPlayerHand(Controller.playerId, hand);
    });

    this.socket.on('flop', function(flop){
        View.renderFlop(flop);
    });

    this.socket.on('turn', function(turn){
        View.renderTurn(turn);
    });

    this.socket.on('river', function(river){
        View.renderRiver(river);
    });
};

Controller.getPlayerId = function()
{
    return Cookies.get('playerId');
};

Controller.createPlayerId = function()
{
    var playerId = uuidv4();
    Cookies.set('playerId', playerId);
    return playerId;
};

var View = {};

View.renderPlayers = function(players, currentPlayerId)
{
    for (var index in players) {
        var player = players[index];
        View.renderPlayer(player.seat, player.playerId, currentPlayerId);
    }
};

View.renderPlayer = function(seat, playerId, currentPlayerId)
{
    if ($('#player-' + playerId).length) {
        return;
    }

    var title = "Seat " + (seat + 1);
    if (playerId === currentPlayerId) {
        title = "<b>" + title + "</b>";
    }

    var player = "<div id='player-" + playerId + "' style='float:left; margin-right: 20px;'>" + title + ": <br><span class='cards'></span></div>";
    $('#hands').append(player);
};

View.removePlayer = function(playerId)
{
    $('#player-' + playerId).remove();
};

View.renderPlayerHand = function(playerId, cards)
{
    var hand = View.renderCards(cards);
    $('#player-' + playerId + " .cards").html(hand);
};

View.renderFlop = function(flop)
{
    $('#cards').html(View.renderCards(flop));
};

View.renderTurn = function(card)
{
    $('#cards').html( $('#cards').html() + View.renderCards([card]));
};

View.renderRiver = function(card)
{
    $('#cards').html( $('#cards').html() + View.renderCards([card]));
};

View.clearTable = function()
{
	$('#cards').html('');
};

View.renderCards = function(cards)
{
    return cards.map(function(card){
        return View.renderCard(card);
    });
};

View.renderCard = function(card)
{
    return '<img src="images/' + card + '.png" style="width: 80px; height: auto; border: 1px solid #aaa; margin: 5px;"/>';
};

$(function(){

	var deck;

	$("#deal").click(function(){
        deck = new Deck($);
        Controller.startGame(deck);
	});
	$("#flop").click(function(){
        Controller.dealFlop(deck);
	});
	$("#turn").click(function(){
        Controller.dealTurn(deck);
	});
	$("#river").click(function(){
        Controller.dealRiver(deck);
	});

	Controller.joinGame();
});

</script>
</head>
<body>

<h3>Cards</h3>
<div id="cards">

</div>

<h3>Players</h3>
<div id="hands">

</div>
<div style="clear:both"></div>
<br><br>
<div id="controls">
    <button id="deal">Deal</button>
    <button id="flop">Flop</button>
    <button id="turn">Turn</button>
    <button id="river">River</button>
</div>

</body>
</html>